<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>과학 실험 준비물 요청 시스템</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@300;400;500;600;700&display=swap');
        body { font-family: 'Noto Sans KR', sans-serif; }
        .calendar-day { min-height: 100px; }
        .experiment-item { font-size: 0.75rem; }
        .experiment-unconfirmed { background-color: #fbcfe8; color: #9d174d; } /* 핑크색 */
        .experiment-confirmed { background-color: #bfdbfe; color: #1e40af; }   /* 하늘색 */
        #modalContent div { 
            white-space: pre-wrap; 
            word-wrap: break-word;
            word-break: break-all;
        }
    </style>
</head>
<body class="bg-gradient-to-br from-blue-50 to-indigo-100 min-h-screen">
    <div class="container mx-auto px-4 py-8">
        <!-- 헤더 -->
        <div class="text-center mb-8">
            <h1 class="text-4xl font-bold text-indigo-800 mb-2">🧪 과학 실험 준비물 요청</h1>
            <p class="text-gray-600">실험 준비물을 쉽게 요청하고 관리하세요</p>
        </div>

        <!-- 요청 폼 -->
        <div class="bg-white rounded-xl shadow-lg p-6 mb-8">
            <h2 class="text-2xl font-semibold text-gray-800 mb-6">과학 실험 준비물 요청</h2>
            <form id="experimentForm" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">날짜</label>
                    <input type="date" id="date" required class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500">
                </div>

                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">교시</label>
                    <select id="period" required class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500">
                        <option value="">선택하세요</option>
                        <option value="1">1교시</option>
                        <option value="2">2교시</option>
                        <option value="3">3교시</option>
                        <option value="4">4교시</option>
                        <option value="5">5교시</option>
                        <option value="6">6교시</option>
                    </select>
                </div>

                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">학년반</label>
                    <input type="text" id="classInfo" placeholder="예: 3학년 2반" required class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500">
                </div>

                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">실험장소</label>
                    <select id="location" required class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500">
                        <option value="">선택하세요</option>
                        <option value="교실">교실</option>
                        <option value="과학실">과학실</option>
                    </select>
                </div>

                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">교과서 쪽수</label>
                    <input type="text" id="pageNumber" placeholder="예: 124-126쪽" required class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500">
                </div>

                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">모둠 수</label>
                    <input type="number" id="groupCount" placeholder="예: 6" min="1" required class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500">
                </div>

                <div class="md:col-span-2 lg:col-span-3">
                    <label class="block text-sm font-medium text-gray-700 mb-2">준비물</label>
                    <textarea id="materials" placeholder="필요한 실험 준비물을 상세히 적어주세요&#10;예) 240ml 비커" required class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 h-24 resize-none"></textarea>
                </div>

                <div class="md:col-span-2 lg:col-span-3">
                    <label class="block text-sm font-medium text-gray-700 mb-2">기타 사항</label>
                    <textarea id="notes" placeholder="추가 요청사항이나 특별한 주의사항이 있으면 적어주세요" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 h-20 resize-none"></textarea>
                </div>

                <div class="md:col-span-2 lg:col-span-3 flex gap-4">
                    <button type="submit" class="bg-indigo-600 hover:bg-indigo-700 text-white px-6 py-3 rounded-lg font-medium transition-colors flex-1">
                        📝 요청 등록
                    </button>
                    <button type="button" id="cancelEdit" class="bg-gray-500 hover:bg-gray-600 text-white px-6 py-3 rounded-lg font-medium transition-colors hidden">
                        취소
                    </button>
                </div>
            </form>
        </div>

        <!-- 달력 -->
        <div class="bg-white rounded-xl shadow-lg p-6">
            <div class="flex justify-between items-center mb-6">
                <h2 class="text-2xl font-semibold text-gray-800">📅 실험 일정</h2>
                <div class="flex gap-2">
                    <button id="prevMonth" class="bg-gray-200 hover:bg-gray-300 px-4 py-2 rounded-lg transition-colors">◀</button>
                    <span id="currentMonth" class="px-4 py-2 font-medium text-gray-800"></span>
                    <button id="nextMonth" class="bg-gray-200 hover:bg-gray-300 px-4 py-2 rounded-lg transition-colors">▶</button>
                </div>
            </div>

            <div class="grid grid-cols-7 gap-1 mb-4">
                <div class="text-center font-medium text-gray-600 py-2">일</div>
                <div class="text-center font-medium text-gray-600 py-2">월</div>
                <div class="text-center font-medium text-gray-600 py-2">화</div>
                <div class="text-center font-medium text-gray-600 py-2">수</div>
                <div class="text-center font-medium text-gray-600 py-2">목</div>
                <div class="text-center font-medium text-gray-600 py-2">금</div>
                <div class="text-center font-medium text-gray-600 py-2">토</div>
            </div>

            <div id="calendarGrid" class="grid grid-cols-7 gap-1">
                <!-- 달력 날짜들이 여기에 동적으로 생성됩니다 -->
            </div>
        </div>
    </div>

    <!-- 수정 모달 -->
    <div id="editModal" class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center z-50">
        <div class="bg-white rounded-xl p-6 max-w-xl w-full mx-4">
            <h3 class="text-xl font-semibold mb-4">실험 요청 관리</h3>
            <div id="modalContent" class="mb-6">
                <!-- 실험 정보가 여기에 표시됩니다 -->
            </div>
            <div class="flex flex-col gap-3">
                <div class="flex gap-3">
                    <button id="editBtn" class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg flex-1 transition-colors">
                        ✏️ 수정
                    </button>
                    <button id="deleteBtn" class="bg-red-600 hover:bg-red-700 text-white px-4 py-2 rounded-lg flex-1 transition-colors">
                        🗑️ 삭제
                    </button>
                </div>
                <button id="confirmBtn" class="bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded-lg transition-colors hidden">
                    ✅ 담당자 확인 (확인 완료 시, 하늘색으로 컬러 변경됨)
                </button>
                <button id="closeModal" class="bg-gray-500 hover:bg-gray-600 text-white px-4 py-2 rounded-lg transition-colors">
                    닫기
                </button>
            </div>
        </div>
    </div>

    <!-- 커스텀 메시지 박스 -->
    <div id="messageBox" class="fixed bottom-8 left-1/2 -translate-x-1/2 bg-indigo-600 text-white px-6 py-3 rounded-lg shadow-lg z-50 transform transition-all duration-300 opacity-0 scale-95">
        <span id="messageText"></span>
    </div>
    
    <!-- Firebase SDK 및 앱 스크립트 -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.6.0/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.6.0/firebase-auth.js";
        import { getFirestore, doc, setDoc, deleteDoc, collection, onSnapshot, addDoc } from "https://www.gstatic.com/firebasejs/10.6.0/firebase-firestore.js";
        
        // 전역 변수 설정
        const appId = typeof window.__app_id !== 'undefined' ? window.__app_id : 'default-app-id';
        const firebaseConfig = JSON.parse(typeof window.__firebase_config !== 'undefined' ? window.__firebase_config : '{}');
        const initialAuthToken = typeof window.__initial_auth_token !== 'undefined' ? window.__initial_auth_token : null;

        // Firebase 초기화
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const auth = getAuth(app);
        
        let experiments = [];
        let currentDate = new Date();
        let editingDocId = null;
        let userId = null;
        let authStateReady = false;

        // 커스텀 메시지 박스 함수
        function showMessage(text) {
            const messageBox = document.getElementById('messageBox');
            const messageText = document.getElementById('messageText');
            messageText.textContent = text;
            messageBox.classList.remove('opacity-0', 'scale-95');
            messageBox.classList.add('opacity-100', 'scale-100');
            setTimeout(() => {
                messageBox.classList.remove('opacity-100', 'scale-100');
                messageBox.classList.add('opacity-0', 'scale-95');
            }, 3000);
        }

        // 커스텀 확인 모달 함수
        function showConfirm(message, onConfirm) {
            const modal = document.createElement('div');
            modal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50';
            modal.innerHTML = `
                <div class="bg-white rounded-xl p-6 max-w-sm w-full mx-4 shadow-lg">
                    <p class="text-gray-800 mb-6">${message}</p>
                    <div class="flex gap-4">
                        <button id="confirmYes" class="bg-red-600 hover:bg-red-700 text-white px-4 py-2 rounded-lg flex-1 transition-colors">네</button>
                        <button id="confirmNo" class="bg-gray-500 hover:bg-gray-600 text-white px-4 py-2 rounded-lg flex-1 transition-colors">아니오</button>
                    </div>
                </div>
            `;
            document.body.appendChild(modal);

            document.getElementById('confirmYes').onclick = () => {
                onConfirm();
                document.body.removeChild(modal);
            };
            document.getElementById('confirmNo').onclick = () => {
                document.body.removeChild(modal);
            };
        }

        // 폼 제출 처리
        document.getElementById('experimentForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            if (!authStateReady) {
                showMessage('인증 상태를 확인 중입니다. 잠시 후 다시 시도해주세요.');
                return;
            }
            
            const formData = {
                date: document.getElementById('date').value,
                period: document.getElementById('period').value,
                classInfo: document.getElementById('classInfo').value,
                location: document.getElementById('location').value,
                pageNumber: document.getElementById('pageNumber').value,
                groupCount: document.getElementById('groupCount').value,
                materials: document.getElementById('materials').value,
                notes: document.getElementById('notes').value,
                isConfirmed: false // 새로운 요청은 항상 미확인 상태로 시작
            };

            try {
                const docRef = doc(db, 'artifacts', appId, 'users', userId);
                const experimentsCollectionRef = collection(docRef, 'experiments');
                
                if (editingDocId) {
                    // 수정 모드
                    const experimentDocRef = doc(experimentsCollectionRef, editingDocId);
                    await setDoc(experimentDocRef, formData);
                    editingDocId = null;
                    document.querySelector('button[type="submit"]').textContent = '📝 요청 등록';
                    document.getElementById('cancelEdit').classList.add('hidden');
                    showMessage('실험 요청이 수정되었습니다!');
                } else {
                    // 새 등록
                    await addDoc(experimentsCollectionRef, formData);
                    showMessage('실험 요청이 등록되었습니다!');
                }
                
                this.reset();
            } catch (e) {
                console.error("Error adding/updating document: ", e);
                showMessage('요청 처리 중 오류가 발생했습니다.');
            }
        });

        // 수정 취소
        document.getElementById('cancelEdit').addEventListener('click', function() {
            editingDocId = null;
            document.getElementById('experimentForm').reset();
            document.querySelector('button[type="submit"]').textContent = '📝 요청 등록';
            this.classList.add('hidden');
        });

        // 달력 렌더링
        function renderCalendar() {
            const year = currentDate.getFullYear();
            const month = currentDate.getMonth();
            
            document.getElementById('currentMonth').textContent = `${year}년 ${month + 1}월`;
            
            const firstDay = new Date(year, month, 1);
            const startDate = new Date(firstDay);
            startDate.setDate(startDate.getDate() - firstDay.getDay());
            
            const calendarGrid = document.getElementById('calendarGrid');
            calendarGrid.innerHTML = '';
            
            for (let i = 0; i < 42; i++) {
                const cellDate = new Date(startDate);
                cellDate.setDate(startDate.getDate() + i);
                
                const dayCell = document.createElement('div');
                dayCell.className = `calendar-day border border-gray-200 p-2 min-h-[100px] cursor-pointer hover:bg-gray-50 rounded-lg`;
                
                const isCurrentMonth = cellDate.getMonth() === month;
                const dateStr = formatDateToString(cellDate);
                
                dayCell.innerHTML = `
                    <div class="font-medium ${isCurrentMonth ? 'text-gray-800' : 'text-gray-400'} mb-1">
                        ${cellDate.getDate()}
                    </div>
                    <div class="space-y-1" id="experiments-${dateStr}">
                        ${getExperimentsForDate(dateStr)}
                    </div>
                `;
                
                calendarGrid.appendChild(dayCell);
            }
        }

        // 특정 날짜의 실험 목록 가져오기
        function getExperimentsForDate(date) {
            const dayExperiments = experiments.filter(exp => exp.date === date);
            return dayExperiments.map(exp => {
                const colorClass = exp.isConfirmed ? 'experiment-confirmed' : 'experiment-unconfirmed';
                return `
                    <div class="experiment-item px-2 py-1 rounded text-xs cursor-pointer transition-colors ${colorClass}" 
                        onclick="showExperimentModal('${exp.id}')">
                        ${exp.period}교시 ${exp.classInfo}
                    </div>
                `;
            }).join('');
        }

        // 날짜를 YYYY-MM-DD 형식으로 변환
        function formatDateToString(date) {
            const year = date.getFullYear();
            const month = String(date.getMonth() + 1).padStart(2, '0');
            const day = String(date.getDate()).padStart(2, '0');
            return `${year}-${month}-${day}`;
        }
        
        // 실험 상세 모달 표시
        window.showExperimentModal = function(id) {
            const experiment = experiments.find(exp => exp.id === id);
            if (!experiment) return;

            // 모달 내용 생성
            const modalContent = document.getElementById('modalContent');
            modalContent.innerHTML = `
                <div class="flex flex-col gap-2 text-sm text-gray-700">
                    <div>1. <strong>날짜:</strong> ${experiment.date}</div>
                    <div>2. <strong>교시:</strong> ${experiment.period}교시</div>
                    <div>3. <strong>학년반:</strong> ${experiment.classInfo}</div>
                    <div>4. <strong>장소:</strong> ${experiment.location}</div>
                    <div>5. <strong>교과서:</strong> ${experiment.pageNumber}</div>
                    <div>6. <strong>모둠 수:</strong> ${experiment.groupCount}개</div>
                    <div>7. <strong>준비물:</strong> ${experiment.materials}</div>
                    ${experiment.notes ? `<div>8. <strong>기타 사항:</strong> ${experiment.notes}</div>` : ''}
                </div>
            `;
            
            // 확인 버튼 상태 및 표시
            const confirmBtn = document.getElementById('confirmBtn');
            if (experiment.isConfirmed) {
                confirmBtn.classList.add('hidden');
                confirmBtn.onclick = null; // 이벤트 리스너 제거
            } else {
                confirmBtn.classList.remove('hidden');
                confirmBtn.onclick = () => confirmExperiment(id);
            }

            // 모달 표시
            const editModal = document.getElementById('editModal');
            editModal.classList.remove('hidden');
            editModal.classList.add('flex');

            // 버튼 이벤트 설정
            document.getElementById('editBtn').onclick = () => editExperiment(id);
            document.getElementById('deleteBtn').onclick = () => deleteExperiment(id);
        }

        // 실험 수정
        function editExperiment(id) {
            const experiment = experiments.find(exp => exp.id === id);
            if (!experiment) return;

            // 폼에 데이터 채우기
            document.getElementById('date').value = experiment.date;
            document.getElementById('period').value = experiment.period;
            document.getElementById('classInfo').value = experiment.classInfo;
            document.getElementById('location').value = experiment.location;
            document.getElementById('pageNumber').value = experiment.pageNumber;
            document.getElementById('groupCount').value = experiment.groupCount;
            document.getElementById('materials').value = experiment.materials;
            document.getElementById('notes').value = experiment.notes;
            
            editingDocId = id;
            document.querySelector('button[type="submit"]').textContent = '✏️ 수정 완료';
            document.getElementById('cancelEdit').classList.add('hidden');

            closeModal();
            document.getElementById('experimentForm').scrollIntoView({ behavior: 'smooth' });
        }

        // 실험 삭제
        function deleteExperiment(id) {
            showConfirm('정말로 이 실험 요청을 삭제하시겠습니까?', async () => {
                try {
                    const docRef = doc(db, 'artifacts', appId, 'users', userId, 'experiments', id);
                    await deleteDoc(docRef);
                    showMessage('실험 요청이 삭제되었습니다.');
                    closeModal();
                } catch (e) {
                    console.error("Error deleting document: ", e);
                    showMessage('삭제 중 오류가 발생했습니다.');
                }
            });
        }
        
        // 실험 확인 완료
        async function confirmExperiment(id) {
            try {
                const docRef = doc(db, 'artifacts', appId, 'users', userId, 'experiments', id);
                await setDoc(docRef, { isConfirmed: true }, { merge: true });
                showMessage('실험 준비물 확인이 완료되었습니다!');
                closeModal();
            } catch (e) {
                console.error("Error updating document: ", e);
                showMessage('확인 처리 중 오류가 발생했습니다.');
            }
        }

        // 모달 닫기
        function closeModal() {
            document.getElementById('editModal').classList.add('hidden');
            document.getElementById('editModal').classList.remove('flex');
        }

        // 이벤트 리스너
        document.getElementById('closeModal').addEventListener('click', closeModal);
        document.getElementById('editModal').addEventListener('click', function(e) {
            if (e.target === this) closeModal();
        });

        document.getElementById('prevMonth').addEventListener('click', function() {
            currentDate.setMonth(currentDate.getMonth() - 1);
            renderCalendar();
        });

        document.getElementById('nextMonth').addEventListener('click', function() {
            currentDate.setMonth(currentDate.getMonth() + 1);
            renderCalendar();
        });

        // Firebase 인증 상태 변경 감지
        onAuthStateChanged(auth, async (user) => {
            if (user) {
                // 사용자가 로그인됨
                userId = user.uid;
                authStateReady = true;
                
                const experimentsCollectionRef = collection(db, 'artifacts', appId, 'users', userId, 'experiments');
                
                // Firestore 데이터 실시간 감지
                onSnapshot(experimentsCollectionRef, (querySnapshot) => {
                    experiments = [];
                    querySnapshot.forEach((doc) => {
                        experiments.push({ id: doc.id, ...doc.data() });
                    });
                    // 데이터가 로드되거나 변경될 때마다 달력을 다시 렌더링합니다.
                    renderCalendar(); 
                }, (error) => {
                    console.error("Error listening to changes: ", error);
                    showMessage('데이터를 불러오는 중 오류가 발생했습니다.');
                });
            } else {
                // 사용자가 로그아웃됨 (익명 로그인 시도)
                try {
                    if (initialAuthToken) {
                        await signInWithCustomToken(auth, initialAuthToken);
                    } else {
                        await signInAnonymously(auth);
                    }
                } catch (error) {
                    console.error("Authentication failed: ", error);
                    showMessage('로그인에 실패했습니다.');
                }
            }
        });

        // 페이지 로드 시 날짜를 오늘 날짜로 설정
        window.onload = function() {
            const today = new Date();
            const year = today.getFullYear();
            const month = String(today.getMonth() + 1).padStart(2, '0');
            const day = String(today.getDate()).padStart(2, '0');
            document.getElementById('date').value = `${year}-${month}-${day}`;
        };
    </script>
</body>
</html>
