<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ê³¼í•™ ì‹¤í—˜ ì¤€ë¹„ë¬¼ ìš”ì²­ ì‹œìŠ¤í…œ</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@300;400;500;600;700&display=swap');
        body { font-family: 'Noto Sans KR', sans-serif; }
        .calendar-day { min-height: 100px; }
        .experiment-item { font-size: 0.75rem; }
    </style>
</head>
<body class="bg-gradient-to-br from-blue-50 to-indigo-100 min-h-screen">
    <div class="container mx-auto px-4 py-8">
        <!-- í—¤ë” -->
        <div class="text-center mb-8">
            <h1 class="text-4xl font-bold text-indigo-800 mb-2">ğŸ§ª ê³¼í•™ ì‹¤í—˜ ì¤€ë¹„ë¬¼ ìš”ì²­</h1>
            <p class="text-gray-600">ì‹¤í—˜ ì¤€ë¹„ë¬¼ì„ ì‰½ê²Œ ìš”ì²­í•˜ì„¸ìš”</p>
        </div>

        <!-- ìš”ì²­ í¼ -->
        <div class="bg-white rounded-xl shadow-lg p-6 mb-8">
            <h2 class="text-2xl font-semibold text-gray-800 mb-6">ìƒˆ ì‹¤í—˜ ìš”ì²­</h2>
            <form id="experimentForm" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">ë‚ ì§œ</label>
                    <input type="date" id="date" required class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500">
                </div>

                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">êµì‹œ</label>
                    <select id="period" required class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500">
                        <option value="">ì„ íƒí•˜ì„¸ìš”</option>
                        <option value="1">1êµì‹œ</option>
                        <option value="2">2êµì‹œ</option>
                        <option value="3">3êµì‹œ</option>
                        <option value="4">4êµì‹œ</option>
                        <option value="5">5êµì‹œ</option>
                        <option value="6">6êµì‹œ</option>
                    </select>
                </div>

                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">í•™ë…„ë°˜</label>
                    <input type="text" id="classInfo" placeholder="ì˜ˆ: 3í•™ë…„ 2ë°˜" required class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500">
                </div>

                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">ì‹¤í—˜ì¥ì†Œ</label>
                    <select id="location" required class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500">
                        <option value="">ì„ íƒí•˜ì„¸ìš”</option>
                        <option value="êµì‹¤">êµì‹¤</option>
                        <option value="ê³¼í•™ì‹¤">ê³¼í•™ì‹¤</option>
                    </select>
                </div>

                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">êµê³¼ì„œ ìª½ìˆ˜</label>
                    <input type="text" id="pageNumber" placeholder="ì˜ˆ: 124-126ìª½" required class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500">
                </div>

                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">ëª¨ë‘  ìˆ˜</label>
                    <input type="number" id="groupCount" placeholder="ì˜ˆ: 6" min="1" required class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500">
                </div>

                <div class="md:col-span-2 lg:col-span-3">
                    <label class="block text-sm font-medium text-gray-700 mb-2">ì¤€ë¹„ë¬¼</label>
                    <textarea id="materials" placeholder="í•„ìš”í•œ ì‹¤í—˜ ì¤€ë¹„ë¬¼ì„ ìƒì„¸íˆ ì ì–´ì£¼ì„¸ìš”&#10;ì˜ˆ) 240ml ë¹„ì»¤" required class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 h-24 resize-none"></textarea>
                </div>

                <div class="md:col-span-2 lg:col-span-3">
                    <label class="block text-sm font-medium text-gray-700 mb-2">ê¸°íƒ€ ì‚¬í•­</label>
                    <textarea id="notes" placeholder="ì¶”ê°€ ìš”ì²­ì‚¬í•­ì´ë‚˜ íŠ¹ë³„í•œ ì£¼ì˜ì‚¬í•­ì´ ìˆìœ¼ë©´ ì ì–´ì£¼ì„¸ìš”" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 h-20 resize-none"></textarea>
                </div>

                <div class="md:col-span-2 lg:col-span-3 flex gap-4">
                    <button type="submit" class="bg-indigo-600 hover:bg-indigo-700 text-white px-6 py-3 rounded-lg font-medium transition-colors flex-1">
                        ğŸ“ ìš”ì²­ ë“±ë¡
                    </button>
                    <button type="button" id="cancelEdit" class="bg-gray-500 hover:bg-gray-600 text-white px-6 py-3 rounded-lg font-medium transition-colors hidden">
                        ì·¨ì†Œ
                    </button>
                </div>
            </form>
        </div>

        <!-- ë‹¬ë ¥ -->
        <div class="bg-white rounded-xl shadow-lg p-6">
            <div class="flex justify-between items-center mb-6">
                <h2 class="text-2xl font-semibold text-gray-800">ğŸ“… ì‹¤í—˜ ì¼ì •</h2>
                <div class="flex gap-2">
                    <button id="prevMonth" class="bg-gray-200 hover:bg-gray-300 px-4 py-2 rounded-lg transition-colors">â—€</button>
                    <span id="currentMonth" class="px-4 py-2 font-medium text-gray-800"></span>
                    <button id="nextMonth" class="bg-gray-200 hover:bg-gray-300 px-4 py-2 rounded-lg transition-colors">â–¶</button>
                </div>
            </div>

            <div class="grid grid-cols-7 gap-1 mb-4">
                <div class="text-center font-medium text-gray-600 py-2">ì¼</div>
                <div class="text-center font-medium text-gray-600 py-2">ì›”</div>
                <div class="text-center font-medium text-gray-600 py-2">í™”</div>
                <div class="text-center font-medium text-gray-600 py-2">ìˆ˜</div>
                <div class="text-center font-medium text-gray-600 py-2">ëª©</div>
                <div class="text-center font-medium text-gray-600 py-2">ê¸ˆ</div>
                <div class="text-center font-medium text-gray-600 py-2">í† </div>
            </div>

            <div id="calendarGrid" class="grid grid-cols-7 gap-1">
                <!-- ë‹¬ë ¥ ë‚ ì§œë“¤ì´ ì—¬ê¸°ì— ë™ì ìœ¼ë¡œ ìƒì„±ë©ë‹ˆë‹¤ -->
            </div>
        </div>
    </div>

    <!-- ìˆ˜ì • ëª¨ë‹¬ -->
    <div id="editModal" class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center z-50">
        <div class="bg-white rounded-xl p-6 max-w-md w-full mx-4">
            <h3 class="text-xl font-semibold mb-4">ì‹¤í—˜ ìš”ì²­ ê´€ë¦¬</h3>
            <div id="modalContent" class="mb-6">
                <!-- ì‹¤í—˜ ì •ë³´ê°€ ì—¬ê¸°ì— í‘œì‹œë©ë‹ˆë‹¤ -->
            </div>
            <div class="flex gap-3">
                <button id="editBtn" class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg flex-1 transition-colors">
                    âœï¸ ìˆ˜ì •
                </button>
                <button id="deleteBtn" class="bg-red-600 hover:bg-red-700 text-white px-4 py-2 rounded-lg flex-1 transition-colors">
                    ğŸ—‘ï¸ ì‚­ì œ
                </button>
                <button id="closeModal" class="bg-gray-500 hover:bg-gray-600 text-white px-4 py-2 rounded-lg transition-colors">
                    ë‹«ê¸°
                </button>
            </div>
        </div>
    </div>

    <!-- ì»¤ìŠ¤í…€ ë©”ì‹œì§€ ë°•ìŠ¤ -->
    <div id="messageBox" class="fixed bottom-8 left-1/2 -translate-x-1/2 bg-indigo-600 text-white px-6 py-3 rounded-lg shadow-lg z-50 transform transition-all duration-300 opacity-0 scale-95">
        <span id="messageText"></span>
    </div>
    
    <!-- Firebase SDK ë° ì•± ìŠ¤í¬ë¦½íŠ¸ -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.6.0/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.6.0/firebase-auth.js";
        import { getFirestore, doc, getDoc, setDoc, deleteDoc, collection, query, onSnapshot, orderBy, where, addDoc } from "https://www.gstatic.com/firebasejs/10.6.0/firebase-firestore.js";
        
        // ì „ì—­ ë³€ìˆ˜ ì„¤ì • (ReferenceError í•´ê²°)
        const appId = typeof window.__app_id !== 'undefined' ? window.__app_id : 'default-app-id';
        const firebaseConfig = JSON.parse(typeof window.__firebase_config !== 'undefined' ? window.__firebase_config : '{}');
        const initialAuthToken = typeof window.__initial_auth_token !== 'undefined' ? window.__initial_auth_token : null;

        // Firebase ì´ˆê¸°í™”
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const auth = getAuth(app);
        
        let experiments = [];
        let currentDate = new Date();
        let editingDocId = null;
        let userId = null;

        // ì»¤ìŠ¤í…€ ë©”ì‹œì§€ ë°•ìŠ¤ í•¨ìˆ˜
        function showMessage(text) {
            const messageBox = document.getElementById('messageBox');
            const messageText = document.getElementById('messageText');
            messageText.textContent = text;
            messageBox.classList.remove('opacity-0', 'scale-95');
            messageBox.classList.add('opacity-100', 'scale-100');
            setTimeout(() => {
                messageBox.classList.remove('opacity-100', 'scale-100');
                messageBox.classList.add('opacity-0', 'scale-95');
            }, 3000);
        }

        // ì»¤ìŠ¤í…€ í™•ì¸ ëª¨ë‹¬ í•¨ìˆ˜
        function showConfirm(message, onConfirm) {
            const modal = document.createElement('div');
            modal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50';
            modal.innerHTML = `
                <div class="bg-white rounded-xl p-6 max-w-sm w-full mx-4 shadow-lg">
                    <p class="text-gray-800 mb-6">${message}</p>
                    <div class="flex gap-4">
                        <button id="confirmYes" class="bg-red-600 hover:bg-red-700 text-white px-4 py-2 rounded-lg flex-1 transition-colors">ë„¤</button>
                        <button id="confirmNo" class="bg-gray-500 hover:bg-gray-600 text-white px-4 py-2 rounded-lg flex-1 transition-colors">ì•„ë‹ˆì˜¤</button>
                    </div>
                </div>
            `;
            document.body.appendChild(modal);

            document.getElementById('confirmYes').onclick = () => {
                onConfirm();
                document.body.removeChild(modal);
            };
            document.getElementById('confirmNo').onclick = () => {
                document.body.removeChild(modal);
            };
        }

        // í¼ ì œì¶œ ì²˜ë¦¬
        document.getElementById('experimentForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const formData = {
                date: document.getElementById('date').value,
                period: document.getElementById('period').value,
                classInfo: document.getElementById('classInfo').value,
                location: document.getElementById('location').value,
                pageNumber: document.getElementById('pageNumber').value,
                groupCount: document.getElementById('groupCount').value,
                materials: document.getElementById('materials').value,
                notes: document.getElementById('notes').value
            };

            try {
                const userDocRef = doc(db, 'artifacts', appId, 'users', userId);
                const experimentsCollectionRef = collection(userDocRef, 'experiments');

                if (editingDocId) {
                    // ìˆ˜ì • ëª¨ë“œ
                    const docRef = doc(experimentsCollectionRef, editingDocId);
                    await setDoc(docRef, formData);
                    editingDocId = null;
                    document.querySelector('button[type="submit"]').textContent = 'ğŸ“ ìš”ì²­ ë“±ë¡';
                    document.getElementById('cancelEdit').classList.add('hidden');
                    showMessage('ì‹¤í—˜ ìš”ì²­ì´ ìˆ˜ì •ë˜ì—ˆìŠµë‹ˆë‹¤!');
                } else {
                    // ìƒˆ ë“±ë¡
                    await addDoc(experimentsCollectionRef, formData);
                    showMessage('ì‹¤í—˜ ìš”ì²­ì´ ë“±ë¡ë˜ì—ˆìŠµë‹ˆë‹¤!');
                }
                
                this.reset();
            } catch (e) {
                console.error("Error adding/updating document: ", e);
                showMessage('ìš”ì²­ ì²˜ë¦¬ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
            }
        });

        // ìˆ˜ì • ì·¨ì†Œ
        document.getElementById('cancelEdit').addEventListener('click', function() {
            editingDocId = null;
            document.getElementById('experimentForm').reset();
            document.querySelector('button[type="submit"]').textContent = 'ğŸ“ ìš”ì²­ ë“±ë¡';
            this.classList.add('hidden');
        });

        // ë‹¬ë ¥ ë Œë”ë§
        function renderCalendar() {
            const year = currentDate.getFullYear();
            const month = currentDate.getMonth();
            
            document.getElementById('currentMonth').textContent = `${year}ë…„ ${month + 1}ì›”`;
            
            const firstDay = new Date(year, month, 1);
            const lastDay = new Date(year, month + 1, 0);
            const startDate = new Date(firstDay);
            startDate.setDate(startDate.getDate() - firstDay.getDay());
            
            const calendarGrid = document.getElementById('calendarGrid');
            calendarGrid.innerHTML = '';
            
            for (let i = 0; i < 42; i++) {
                const cellDate = new Date(startDate);
                cellDate.setDate(startDate.getDate() + i);
                
                const dayCell = document.createElement('div');
                dayCell.className = `calendar-day border border-gray-200 p-2 min-h-[100px] cursor-pointer hover:bg-gray-50 rounded-lg`;
                
                const isCurrentMonth = cellDate.getMonth() === month;
                const dateStr = formatDateToString(cellDate);
                
                dayCell.innerHTML = `
                    <div class="font-medium ${isCurrentMonth ? 'text-gray-800' : 'text-gray-400'} mb-1">
                        ${cellDate.getDate()}
                    </div>
                    <div class="space-y-1" id="experiments-${dateStr}">
                        ${getExperimentsForDate(dateStr)}
                    </div>
                `;
                
                calendarGrid.appendChild(dayCell);
            }
        }

        // íŠ¹ì • ë‚ ì§œì˜ ì‹¤í—˜ ëª©ë¡ ê°€ì ¸ì˜¤ê¸°
        function getExperimentsForDate(date) {
            const dayExperiments = experiments.filter(exp => exp.date === date);
            return dayExperiments.map(exp => `
                <div class="experiment-item bg-indigo-100 text-indigo-800 px-2 py-1 rounded text-xs cursor-pointer hover:bg-indigo-200 transition-colors" 
                    onclick="showExperimentModal('${exp.id}')">
                    ${exp.period}êµì‹œ ${exp.classInfo}
                </div>
            `).join('');
        }

        // ë‚ ì§œë¥¼ YYYY-MM-DD í˜•ì‹ìœ¼ë¡œ ë³€í™˜
        function formatDateToString(date) {
            const year = date.getFullYear();
            const month = String(date.getMonth() + 1).padStart(2, '0');
            const day = String(date.getDate()).padStart(2, '0');
            return `${year}-${month}-${day}`;
        }
        
        // ì‹¤í—˜ ìƒì„¸ ëª¨ë‹¬ í‘œì‹œ
        window.showExperimentModal = function(id) {
            const experiment = experiments.find(exp => exp.id === id);
            if (!experiment) return;

            document.getElementById('modalContent').innerHTML = `
                <div class="space-y-3 text-sm text-gray-700">
                    <div><strong>ë‚ ì§œ:</strong> ${experiment.date}</div>
                    <div><strong>êµì‹œ:</strong> ${experiment.period}êµì‹œ</div>
                    <div><strong>í•™ë…„ë°˜:</strong> ${experiment.classInfo}</div>
                    <div><strong>ì¥ì†Œ:</strong> ${experiment.location}</div>
                    <div><strong>êµê³¼ì„œ:</strong> ${experiment.pageNumber}</div>
                    <div><strong>ëª¨ë‘  ìˆ˜:</strong> ${experiment.groupCount}ê°œ</div>
                    <div><strong>ì¤€ë¹„ë¬¼:</strong> ${experiment.materials.replace(/\n/g, '<br>')}</div>
                    ${experiment.notes ? `<div><strong>ê¸°íƒ€:</strong> ${experiment.notes.replace(/\n/g, '<br>')}</div>` : ''}
                </div>
            `;

            document.getElementById('editModal').classList.remove('hidden');
            document.getElementById('editModal').classList.add('flex');

            // ë²„íŠ¼ ì´ë²¤íŠ¸ ì„¤ì •
            document.getElementById('editBtn').onclick = () => editExperiment(id);
            document.getElementById('deleteBtn').onclick = () => deleteExperiment(id);
        }

        // ì‹¤í—˜ ìˆ˜ì •
        function editExperiment(id) {
            const experiment = experiments.find(exp => exp.id === id);
            if (!experiment) return;

            // í¼ì— ë°ì´í„° ì±„ìš°ê¸°
            document.getElementById('date').value = experiment.date;
            document.getElementById('period').value = experiment.period;
            document.getElementById('classInfo').value = experiment.classInfo;
            document.getElementById('location').value = experiment.location;
            document.getElementById('pageNumber').value = experiment.pageNumber;
            document.getElementById('groupCount').value = experiment.groupCount;
            document.getElementById('materials').value = experiment.materials;
            document.getElementById('notes').value = experiment.notes;

            editingDocId = id;
            document.querySelector('button[type="submit"]').textContent = 'âœï¸ ìˆ˜ì • ì™„ë£Œ';
            document.getElementById('cancelEdit').classList.remove('hidden');

            closeModal();
            document.getElementById('experimentForm').scrollIntoView({ behavior: 'smooth' });
        }

        // ì‹¤í—˜ ì‚­ì œ
        function deleteExperiment(id) {
            showConfirm('ì •ë§ë¡œ ì´ ì‹¤í—˜ ìš”ì²­ì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?', async () => {
                try {
                    const docRef = doc(db, 'artifacts', appId, 'users', userId, 'experiments', id);
                    await deleteDoc(docRef);
                    showMessage('ì‹¤í—˜ ìš”ì²­ì´ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.');
                    closeModal();
                } catch (e) {
                    console.error("Error deleting document: ", e);
                    showMessage('ì‚­ì œ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
                }
            });
        }

        // ëª¨ë‹¬ ë‹«ê¸°
        function closeModal() {
            document.getElementById('editModal').classList.add('hidden');
            document.getElementById('editModal').classList.remove('flex');
        }

        // ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ
        document.getElementById('closeModal').addEventListener('click', closeModal);
        document.getElementById('editModal').addEventListener('click', function(e) {
            if (e.target === this) closeModal();
        });

        document.getElementById('prevMonth').addEventListener('click', function() {
            currentDate.setMonth(currentDate.getMonth() - 1);
            renderCalendar();
        });

        document.getElementById('nextMonth').addEventListener('click', function() {
            currentDate.setMonth(currentDate.getMonth() + 1);
            renderCalendar();
        });

        // Firebase ì¸ì¦ ìƒíƒœ ë³€ê²½ ê°ì§€
        onAuthStateChanged(auth, async (user) => {
            if (user) {
                // ì‚¬ìš©ìê°€ ë¡œê·¸ì¸ë¨
                userId = user.uid;
                const experimentsCollectionRef = collection(db, 'artifacts', appId, 'users', userId, 'experiments');
                
                // Firestore ë°ì´í„° ì‹¤ì‹œê°„ ê°ì§€
                onSnapshot(experimentsCollectionRef, (querySnapshot) => {
                    experiments = [];
                    querySnapshot.forEach((doc) => {
                        experiments.push({ id: doc.id, ...doc.data() });
                    });
                    renderCalendar();
                }, (error) => {
                    console.error("Error listening to changes: ", error);
                    showMessage('ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
                });
            } else {
                // ì‚¬ìš©ìê°€ ë¡œê·¸ì•„ì›ƒë¨ (ìµëª… ë¡œê·¸ì¸ ì‹œë„)
                try {
                    if (initialAuthToken) {
                        await signInWithCustomToken(auth, initialAuthToken);
                    } else {
                        await signInAnonymously(auth);
                    }
                } catch (error) {
                    console.error("Authentication failed: ", error);
                    showMessage('ë¡œê·¸ì¸ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
                }
            }
        });

    </script>
</body>
</html>
